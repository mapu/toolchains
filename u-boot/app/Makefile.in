#
# (C) Copyright 2000-2006
# Wolfgang Denk, DENX Software Engineering, wd@denx.de.
#
# SPDX-License-Identifier:	GPL-2.0+
#

include $(TOPDIR)/config.mk

APPTOPDIR := $(CURDIR)
export APPTOPDIR

include $(TOPDIR)/app/config.mk

ELF-y        := @program_name@

#
# Some versions of make do not handle trailing white spaces properly;
# leading to build failures. The problem was found with GNU Make 3.80.
# Using 'strip' as a workaround for the problem.
#
ELF := $(strip $(ELF-y))

SREC := $(addsuffix .srec,$(ELF))
BIN  := $(addsuffix .bin,$(ELF))

SRCS	:= $(CSRCS) $(ASRCS) 
OBJS	:= $(addprefix $(obj),$(CSRCS:.c=.o))
OBJS	+= $(addprefix $(obj),$($(ASRCS:.S=.o):.s=.o))
ELF	:= $(addprefix $(obj),$(ELF))
BIN	:= $(addprefix $(obj),$(BIN))
SREC	:= $(addprefix $(obj),$(SREC))

#########################################################################
# Libraries

# Add sub source directories here
# LIBS-y += subdir/
### subdir Makefile #######################################
# include $(TOPDIR)/app/config.mk

# obj-y	+= $(CSRCS:.c=.o)
# obj-y	+= $($(ASRCS:.S=.o):.s=.o)
### Copy and umcomment above lines into subdir Makefile ###

LIBS-y := $(patsubst %/, %/built-in.o, $(LIBS-y))
LIBS := $(addprefix $(obj),$(sort $(LIBS-y)))
__LIBS := $(subst $(obj),,$(LIBS))
.PHONY : $(LIBS)

#########################################################################

gcclibdir := $(shell dirname `$(CC) -print-libgcc-file-name`)

build := -f $(TOPDIR)/scripts/Makefile.build -C
all:	$(obj).depend $(LIBS) $(OBJS) $(SREC) $(BIN) $(ELF)

#########################################################################
$(ELF):		$(OBJS)
		$(LD) $(LDFLAGS) -g -Ttext $(CONFIG_STANDALONE_LOAD_ADDR) \
			-o $@ -e $(SYM_PREFIX)$(notdir $(<:.o=)) $^ \
			$(OBJTREE)/app/libstubs.o\
			-L$(gcclibdir) -lgcc
		install -m 644 -D $@ $(TOPDIR)/../fs_root/app/$(ELF-y)

$(LIBS):
		$(MAKE) $(build) $(dir $(subst $(obj),,$@))

$(SREC):
$(obj)%.srec:	$(obj)%
		$(OBJCOPY) -O srec $< $@ 2>/dev/null

$(BIN):
$(obj)%.bin:	$(obj)%
		$(OBJCOPY) -O binary $< $@ 2>/dev/null

#########################################################################

# defines $(obj).depend target
include $(SRCTREE)/rules.mk

sinclude $(obj).depend

#########################################################################
